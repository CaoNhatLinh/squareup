const admin = require('firebase-admin');const cron = require('node-cron');const db = admin.database();const { invitation: invitationConfig, general } = require('../../config/cleanup.config');const {    EXPIRY_TIME: INVITATION_EXPIRY_TIME,    CRON_SCHEDULE,    CLEANUP_INTERVAL,    AUTO_DELETE_EXPIRED,    RETENTION_TIME: EXPIRED_RETENTION_TIME,    CLEANUP_STATUSES} = invitationConfig;async function cleanupExpiredInvitations() {    try {        const now = Date.now();        const snapshot = await db.ref('invitations').get();        if (!snapshot.exists()) {            return { expired: 0, deleted: 0 };        }        const expiredInvitations = [];        const toDelete = [];        const updates = {};        snapshot.forEach((child) => {            const invitation = child.val();            const invitationId = child.key;            if (!CLEANUP_STATUSES[invitation.status]) {                return;            }            if (invitation.status === 'pending' && invitation.expiresAt && invitation.expiresAt < now) {                if (AUTO_DELETE_EXPIRED) {                    const expiredAt = invitation.expiredAt || invitation.expiresAt;                    const deletionTime = expiredAt + EXPIRED_RETENTION_TIME;                    if (now >= deletionTime) {                        toDelete.push({                            id: invitationId,                            email: invitation.email,                            restaurantName: invitation.restaurantName,                            reason: 'retention_expired'                        });                    } else if (!invitation.expiredAt) {                        updates[`invitations/${invitationId}/status`] = 'expired';                        updates[`invitations/${invitationId}/expiredAt`] = now;                        expiredInvitations.push({                            id: invitationId,                            email: invitation.email,                            restaurantName: invitation.restaurantName,                            deletesAt: new Date(deletionTime).toLocaleString(general.TIMEZONE)                        });                    }                } else {                    if (invitation.status === 'pending') {                        updates[`invitations/${invitationId}/status`] = 'expired';                        updates[`invitations/${invitationId}/expiredAt`] = now;                        expiredInvitations.push({                            id: invitationId,                            email: invitation.email,                            restaurantName: invitation.restaurantName,                        });                    }                }            }            else if (invitation.status !== 'pending' && CLEANUP_STATUSES[invitation.status]) {                if (AUTO_DELETE_EXPIRED && invitation.expiredAt) {                    const deletionTime = invitation.expiredAt + EXPIRED_RETENTION_TIME;                    if (now >= deletionTime) {                        toDelete.push({                            id: invitationId,                            email: invitation.email,                            restaurantName: invitation.restaurantName,                            status: invitation.status,                            reason: 'retention_expired'                        });                    }                }            }        });        if (Object.keys(updates).length > 0) {            await db.ref().update(updates);            console.log(`[Invitation Cleanup] Marked ${expiredInvitations.length} invitations as expired`);            if (expiredInvitations.length > 0) {                console.log('  Details:', expiredInvitations.map(inv =>                    `${inv.email} (${inv.restaurantName})${inv.deletesAt ? ` - deletes at ${inv.deletesAt}` : ''}`                ).join(', '));            }        }        if (toDelete.length > 0) {            const deletePromises = toDelete.map(inv =>                db.ref(`invitations/${inv.id}`).remove()            );            await Promise.all(deletePromises);            console.log(`[Invitation Cleanup] Permanently deleted ${toDelete.length} invitations`);            console.log('  Details:', toDelete.map(inv =>                `${inv.email} (${inv.restaurantName}) - ${inv.reason}`            ).join(', '));        }        return {            expired: expiredInvitations.length,            deleted: toDelete.length        };    } catch (error) {        console.error('[Invitation Cleanup] Error cleaning up invitations:', error);        return { expired: 0, deleted: 0, error: error.message };    }}function startInvitationCleanupScheduler() {    const expiryMinutes = Math.floor(INVITATION_EXPIRY_TIME / 1000 / 60);    const retentionDays = Math.floor(EXPIRED_RETENTION_TIME / 1000 / 60 / 60 / 24);    const schedule = CRON_SCHEDULE || `*/${Math.floor(CLEANUP_INTERVAL / 1000 / 60)} * * * *`;    console.log('╔════════════════════════════════════════════════════════════╗');    console.log('║     INVITATION CLEANUP SCHEDULER STARTED                  ║');    console.log('╠════════════════════════════════════════════════════════════╣');    console.log(`║  Schedule:              ${schedule.padEnd(33)}║`);    console.log(`║  Invitation Expiry:     ${expiryMinutes} minutes${' '.repeat(27 - expiryMinutes.toString().length)}║`);    console.log(`║  Auto-Delete:           ${AUTO_DELETE_EXPIRED ? 'ENABLED' : 'DISABLED'}${' '.repeat(29 - (AUTO_DELETE_EXPIRED ? 7 : 8))}║`);    if (AUTO_DELETE_EXPIRED) {        console.log(`║  Retention Period:      ${retentionDays} days${' '.repeat(28 - retentionDays.toString().length)}║`);    }    console.log('╠════════════════════════════════════════════════════════════╣');    console.log('║  Cleanup Targets:                                          ║');    Object.entries(CLEANUP_STATUSES).forEach(([status, enabled]) => {        const statusDisplay = `${status}:`;        const enabledDisplay = enabled ? '✓' : '✗';        console.log(`║    ${statusDisplay.padEnd(15)} ${enabledDisplay}${' '.repeat(38)}║`);    });    console.log('╚════════════════════════════════════════════════════════════╝');    cleanupExpiredInvitations();    cron.schedule(schedule, () => {        cleanupExpiredInvitations();    });}module.exports = {    cleanupExpiredInvitations,    startInvitationCleanupScheduler,};